jobs:
- job: 'Publish_Assets'
  pool:
    vmImage: 'ubuntu-16.04'
  variables:
    buildConfiguration: 'Release'
  steps:
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(Build.SourcesDirectory)/assets/'
      ArtifactName: 'assets'

- job: 'Publish_Linux_x64'
  pool:
    vmImage: 'ubuntu-16.04'
  variables:
    buildConfiguration: 'Release'
  steps:
  - template: publish-rid.yml
    parameters:
      runtime: 'linux-x64'
      outputPath: '$(Build.ArtifactStagingDirectory)/pub/linux-x64'

- job: 'Publish_macOS_x64'
  pool:
    vmImage: 'macOS-10.13'
  variables:
    buildConfiguration: 'Release'
  steps:
  - template: publish-rid.yml
    parameters:
      runtime: 'osx-x64'
      outputPath: '$(Build.ArtifactStagingDirectory)/pub/osx-x64'

- job: 'Publish_Windows_x64'
  pool:
    vmImage: 'vs2017-win2016'
  variables:
    buildConfiguration: 'Release'
  workspace:
    clean: outputs
  steps:
  - bash:
    type: inline
    script: |
      # download and verify MinGit 64
      curl -Lo mingit64.zip https://github.com/git-for-windows/git/releases/download/v2.20.1.windows.1/MinGit-2.20.1-busybox-64-bit.zip
      (echo -n "9817ab455d9cbd0b09d8664b4afbe4bbf78d18b556b3541d09238501a749486c *mingit64.zip" | sha256sum -c -) || exit 1

      # unzip MinGit 64 and add to assets
      (unzip -o mingit64.zip -d $(Build.SourcesDirectory)/assets/git) || exit 1
  - template: publish-rid.yml
    parameters:
      runtime: 'win-x64'
      outputPath: '$(Build.ArtifactStagingDirectory)/pub/win-x64'

- job: 'Publish_Windows_x86'
  pool:
    vmImage: 'vs2017-win2016'
  variables:
    buildConfiguration: 'Release'
  workspace:
    clean: outputs
  steps:
  - bash:
    type: inline
    script: |
      # download and verify MinGit 32
      curl -Lo mingit32.zip https://github.com/git-for-windows/git/releases/download/v2.20.1.windows.1/MinGit-2.20.1-busybox-32-bit.zip
      (echo -n "da0c03e3b6e77004efafd7c244dc62e92b4f78642d83234b0c62367c6ab2ad95 *mingit32.zip" | sha256sum -c -) || exit 1

      # unzip MinGit 32 and add to pub-win-x86
      (unzip -o mingit32.zip -d $(Build.SourcesDirectory)/assets/git) || exit 1
  - template: publish-rid.yml
    parameters:
      runtime: 'win-x86'
      outputPath: '$(Build.ArtifactStagingDirectory)/pub/win-x86'
